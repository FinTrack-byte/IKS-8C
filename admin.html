<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin – IKS 8C</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a0dad;
            --secondary-color: #8b5cf6;
            --background-start: #e0eafc;
            --background-end: #cfdef3;
            --card-bg: #ffffff;
            --text-color: #333333;
            --secondary-text-color: #666666;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #e0e0e0;
            --danger-color: #ff4d4d;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: -50px;
            left: -50px;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2) 0%, transparent 70%);
            animation: move-background 20s infinite alternate ease-in-out;
            z-index: -1;
        }

        @keyframes move-background {
            from { transform: translate(0, 0); }
            to { transform: translate(100px, 100px); }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, background-color 0.2s, box-shadow 0.2s;
        }

        .btn.primary {
            border: none;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(106, 13, 173, 0.3);
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #7c3aed, #8b5cf6);
            box-shadow: 0 6px 20px rgba(106, 13, 173, 0.4);
        }
        
        .btn.secondary {
            border: 2px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
        }

        .btn.secondary:hover {
            transform: translateY(-2px);
            background: rgba(106, 13, 173, 0.1);
        }

        .btn.danger {
            background: var(--danger-color);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
        }

        .btn.danger:hover {
            background: #d93d3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4);
        }

        .wrap {
            padding: 24px;
            max-width: 100%;
            margin: auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 8px 20px var(--shadow-color);
            padding: 24px;
            margin: 20px 0;
        }
        
        h3, h4 {
            color: var(--primary-color);
            margin: 0 0 15px 0;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
            text-align: start;
        }

        th {
            font-weight: 600;
            color: var(--secondary-text-color);
            text-transform: uppercase;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        select, input[type='text'] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            font-size: 16px;
            color: var(--text-color);
            margin: 8px 0;
            background-color: #f7f7f7;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        select:focus, input[type='text']:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }

        .muted {
            font-size: 12px;
            color: var(--secondary-text-color);
            margin-top: 10px;
            display: block;
        }
        
        .assignment-card {
            background: #f7f7f7;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
            margin: 12px 0;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        
        .assignment-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .assignment-card strong {
            color: var(--primary-color);
        }
        
        .assignment-card a, .assignment-card img {
            display: block;
            margin-top: 10px;
        }
        
        .assignment-card a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .assignment-card a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .assignment-card img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
    </style>
    <script type="module">
        import { auth, db } from "./firebase.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { ref, onValue, update, remove, push, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // تم تحديث هذه المصفوفة لتشمل "Math"
        const SUBJECTS = ["Arabic", "English", "EnglishPlus", "ICT", "Math", "Science", "Social", "Economics"];
        const $ = (id) => document.getElementById(id);

        let me = null;
        onAuthStateChanged(auth, async (u) => {
            if (!u) {
                location.href = "login.html";
                return;
            }
            me = u;
            const snap = await get(ref(db, "users/" + u.uid));
            if (!snap.exists() || snap.val().role !== "admin") {
                alert("Admins only.");
                location.href = "app.html";
                return;
            }
            $("who").innerText = u.displayName || u.email;
            loadUsers();
            loadHomework();
        });

        window.logout = () => signOut(auth).then(() => location.href = "index.html");

        function loadUsers() {
            onValue(ref(db, "users"), (snap) => {
                const tb = $("usersBody");
                tb.innerHTML = "";
                snap.forEach(ch => {
                    const d = ch.val();
                    const id = ch.key;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${d.name || "-"}</td>
                        <td>${d.email || "-"}</td>
                        <td>
                            <select data-id="${id}" class="roleSel">
                                <option value="student" ${d.role === "student" ? "selected" : ""}>student</option>
                                <option value="admin" ${d.role === "admin" ? "selected" : ""}>admin</option>
                                <option value="disabled" ${d.role === "disabled" ? "selected" : ""}>disabled</option>
                            </select>
                        </td>
                        <td><button class="btn danger" data-id="${id}" data-action="softdel">Deactivate</button></td>
                    `;
                    tb.appendChild(tr);
                });
                document.querySelectorAll(".roleSel").forEach(s => {
                    s.onchange = () => update(ref(db, "users/" + s.dataset.id), { role: s.value });
                });
                document.querySelectorAll("button[data-action='softdel']").forEach(b => {
                    b.onclick = () => update(ref(db, "users/" + b.dataset.id), { role: "disabled" });
                });
            });
        }

        function loadHomework() {
            // تحديث: إعادة إنشاء أقسام الواجبات لكل مادة في مصفوفة SUBJECTS
            const assignmentList = document.querySelector(".assignment-list");
            assignmentList.innerHTML = "";

            SUBJECTS.forEach(sub => {
                const subTitle = sub.replace("EnglishPlus", "English+").replace("Social", "Social Studies");
                const subCard = document.createElement("div");
                subCard.className = "card";
                subCard.innerHTML = `<h4>${subTitle}</h4><div id="hw_${sub}"></div>`;
                assignmentList.appendChild(subCard);

                onValue(ref(db, "homework/" + sub), (snap) => {
                    const list = $(`hw_${sub}`);
                    list.innerHTML = "";
                    if (!snap.exists()) {
                        list.innerHTML = "<div class='muted'>No assignments.</div>";
                        return;
                    }
                    snap.forEach(ch => {
                        const d = ch.val();
                        const id = ch.key;
                        const div = document.createElement("div");
                        div.className = "assignment-card";
                        div.innerHTML = `
                            <div><strong>${d.text || "Assignment"}</strong></div>
                            ${d.fileUrl ? `<img src='${d.fileUrl}' alt='Assignment Image'>` : ""}
                            <div class='muted'>${new Date(d.createdAt || Date.now()).toLocaleString()}</div>
                            <div style='margin-top:8px;display:flex;gap:8px'>
                                <button class='btn danger' data-sub='${sub}' data-id='${id}' data-action='del'>Delete</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                });
            });

            document.addEventListener("click", async (e) => {
                const t = e.target;
                if (t.matches("button[data-action='del']")) {
                    const sub = t.dataset.sub,
                        id = t.dataset.id;
                    if (confirm("Are you sure you want to delete this assignment?")) {
                        await remove(ref(db, `homework/${sub}/${id}`));
                    }
                }
            });
        }

        window.addHw = async () => {
            const sub = $("hwSubject").value;
            const text = $("hwText").value.trim();
            const url = $("hwUrl").value.trim();

            if (!text && !url) {
                alert("Please add assignment text or a valid image URL.");
                return;
            }

            try {
                await push(ref(db, "homework/" + sub), {
                    text,
                    fileUrl: url || null,
                    authorId: me.uid,
                    createdAt: Date.now()
                });
                $("hwText").value = "";
                $("hwUrl").value = "";
                alert("Assignment added successfully.");
            } catch (error) {
                alert("Failed to add assignment: " + error.message);
            }
        };

    </script>
</head>
<body>
    <header>
        <div class="header-title">Admin – IKS 8C</div>
        <div>Signed in as: <strong id="who"></strong></div>
        <div style="display:flex;gap:8px">
            <button class="btn secondary" onclick="location.href='app.html'">Back to App</button>
            <button class="btn secondary" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="wrap">
        <div class="card">
            <h3>User Management</h3>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
            <div class="muted">Note: User roles are managed from here. A 'disabled' role prevents login.</div>
        </div>

        <div class="card">
            <h3>Add New Assignment</h3>
            <select id="hwSubject">
                <option>Arabic</option>
                <option>English</option>
                <option>EnglishPlus</option>
                <option>ICT</option>
                <option>Math</option>
                <option>Science</option>
                <option>Social</option>
                <option>Economics</option>
            </select>
            <input id="hwText" type="text" placeholder="Assignment text (optional)">
            <input id="hwUrl" type="text" placeholder="Image URL (optional)">
            <button class="btn primary" onclick="addHw()">Add Assignment</button>
        </div>

        <div class="card">
            <h3>All Assignments</h3>
            <div class="assignment-list">
                <div class="card"><h4>Arabic</h4><div id="hw_Arabic"></div></div>
                <div class="card"><h4>English</h4><div id="hw_English"></div></div>
                <div class="card"><h4>English+</h4><div id="hw_EnglishPlus"></div></div>
                <div class="card"><h4>ICT</h4><div id="hw_ICT"></div></div>
                <div class="card"><h4>Science</h4><div id="hw_Science"></div></div>
                <div class="card"><h4>Social Studies</h4><div id="hw_Social"></div></div>
                <div class="card"><h4>Economics</h4><div id="hw_Economics"></div></div>
                <div class="card"><h4>Math</h4><div id="hw_Math"></div></div>
            </div>
        </div>
    </div>
</body>
</html>
